<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>דיווח שעות עבודה</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/1.6.5/flowbite.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/1.6.5/flowbite.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/luxon/3.3.0/luxon.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/he.js"></script>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">דיווח שעות עבודה</h1>
        
        <div class="mb-6">
            <label for="view-selector" class="block mb-2 text-sm font-medium text-gray-900">בחר תצוגה:</label>
            <select id="view-selector" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" aria-label="בחירת תצוגת דוח">
                <option value="month">חודשי</option>
                <option value="day">יומי</option>
            </select>
        </div>

        <div id="report-container" class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">דו"ח זמני עבודה</h2>
            <div id="report-content"></div>
        </div>
    </div>

    <!-- Modal for editing -->
    <div id="edit-modal" tabindex="-1" aria-hidden="true" class="fixed top-0 left-0 right-0 z-50 hidden w-full p-4 overflow-x-hidden overflow-y-auto md:inset-0 h-[calc(100%-1rem)] max-h-full">
        <div class="relative w-full max-w-md max-h-full">
            <div class="relative bg-white rounded-lg shadow">
                <button type="button" class="absolute top-3 right-2.5 text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center" data-modal-hide="edit-modal" aria-label="סגור חלון">
                    <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                    <span class="sr-only">סגור חלון</span>
                </button>
                <div class="px-6 py-6 lg:px-8">
                    <h3 class="mb-4 text-xl font-medium text-gray-900">עריכת רשומה</h3>
                    <form id="edit-form" class="space-y-6" novalidate>
                        <input type="hidden" id="edit-id">
                        <div>
                            <label for="edit-date" class="block mb-2 text-sm font-medium text-gray-900">תאריך:</label>
                            <input type="text" id="edit-date" name="date" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required aria-required="true" aria-invalid="false">
                            <p id="edit-date-error" class="mt-2 text-sm text-red-600 hidden"></p>
                        </div>
                        <div>
                            <label for="edit-type" class="block mb-2 text-sm font-medium text-gray-900">סוג דיווח:</label>
                            <select id="edit-type" name="type" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required aria-required="true" aria-invalid="false">
                                <option value="">בחר סוג דיווח</option>
                                <option value="work">עבודה רגילה</option>
                                <option value="sick">מחלה</option>
                                <option value="vacation">חופשה</option>
                                <option value="reserve">מילואים</option>
                                <option value="bereavement">אבל</option>
                                <option value="study">ימי השתלמות</option>
                            </select>
                            <p id="edit-type-error" class="mt-2 text-sm text-red-600 hidden"></p>
                        </div>
                        <div>
                            <label for="edit-location" class="block mb-2 text-sm font-medium text-gray-900">מיקום עבודה:</label>
                            <input type="text" id="edit-location" name="location" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required aria-required="true" aria-invalid="false" minlength="2" maxlength="50">
                            <p id="edit-location-error" class="mt-2 text-sm text-red-600 hidden"></p>
                        </div>
                        <div>
                            <label for="edit-client" class="block mb-2 text-sm font-medium text-gray-900">לקוח לחיוב:</label>
                            <input type="text" id="edit-client" name="client" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required aria-required="true" aria-invalid="false" minlength="2" maxlength="50">
                            <p id="edit-client-error" class="mt-2 text-sm text-red-600 hidden"></p>
                        </div>
                        <div>
                            <label for="edit-start-time" class="block mb-2 text-sm font-medium text-gray-900">שעת התחלה:</label>
                            <input type="text" id="edit-start-time" name="start-time" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required aria-required="true" aria-invalid="false">
                            <p id="edit-start-time-error" class="mt-2 text-sm text-red-600 hidden"></p>
                        </div>
                        <div>
                            <label for="edit-end-time" class="block mb-2 text-sm font-medium text-gray-900">שעת סיום:</label>
                            <input type="text" id="edit-end-time" name="end-time" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required aria-required="true" aria-invalid="false">
                            <p id="edit-end-time-error" class="mt-2 text-sm text-red-600 hidden"></p>
                        </div>
                        <button type="submit" class="w-full text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">עדכן רשומה</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        const DateTime = luxon.DateTime;
        let workLogs = JSON.parse(localStorage.getItem('workLogs')) || [];
        let currentDate = DateTime.now();

        // Initialize Flatpickr for date and time inputs
        flatpickr.localize(flatpickr.l10ns.he);

        flatpickr("#edit-date", {
            dateFormat: "Y-m-d",
            allowInput: true,
            altInput: true,
            altFormat: "d/m/Y",
        });

        flatpickr("#edit-start-time, #edit-end-time", {
            enableTime: true,
            noCalendar: true,
            dateFormat: "H:i",
            time_24hr: true,
            minuteIncrement: 15,
        });

        function saveWorkLogs() {
            localStorage.setItem('workLogs', JSON.stringify(workLogs));
        }

        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
            document.getElementById(elementId.replace('-error', '')).setAttribute('aria-invalid', 'true');
        }

        function hideError(elementId) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = '';
            errorElement.classList.add('hidden');
            document.getElementById(elementId.replace('-error', '')).setAttribute('aria-invalid', 'false');
        }

        function validateForm(formId) {
            const form = document.getElementById(formId);
            let isValid = true;

            // Validate each field
            form.querySelectorAll('input, select').forEach(element => {
                if (element.hasAttribute('required') && !element.value.trim()) {
                    showError(`${element.id}-error`, 'שדה זה הוא חובה');
                    isValid = false;
                } else if (element.minLength && element.value.trim().length < element.minLength) {
                    showError(`${element.id}-error`, `אורך מינימלי הוא ${element.minLength} תווים`);
                    isValid = false;
                } else if (element.maxLength && element.value.trim().length > element.maxLength) {
                    showError(`${element.id}-error`, `אורך מקסימלי הוא ${element.maxLength} תווים`);
                    isValid = false;
                } else {
                    hideError(`${element.id}-error`);
                }
            });

            // Validate time range
            const startTime = form.querySelector('[name="start-time"]').value;
            const endTime = form.querySelector('[name="end-time"]').value;
            if (startTime && endTime && startTime >= endTime) {
                showError(`${formId === 'work-log-form' ? '' : formId === 'edit-form' ? 'edit-' : 'day-'}end-time-error`, 'שעת הסיום חייבת להיות אחרי שעת ההתחלה');
                isValid = false;
            }

            return isValid;
        }

        document.getElementById('view-selector').addEventListener('change', updateReport);

        function updateReport() {
            const view = document.getElementById('view-selector').value;
            const reportContent = document.getElementById('report-content');
            reportContent.innerHTML = '';

            if (workLogs.length === 0) {
                reportContent.innerHTML = '<p>אין דיווחים להצגה.</p>';
                return;
            }

            switch (view) {
                case 'month':
                    displayMonthCalendar();
                    break;
                case 'day':
                    displayDayView(currentDate);
                    break;
            }
        }

        function displayMonthCalendar() {
            const reportContent = document.getElementById('report-content');
            const startOfMonth = currentDate.startOf('month');
            const endOfMonth = currentDate.endOf('month');
            const totalDays = endOfMonth.day;

            let html = `
                <div class="flex justify-between items-center mb-4">
                    <button onclick="changeMonth(-1)" class="text-blue-600 hover:text-blue-800" aria-label="חודש קודם">&lt; חודש קודם</button>
                    <h3 class="text-lg font-semibold">${currentDate.toFormat('MMMM yyyy')}</h3>
                    <button onclick="changeMonth(1)" class="text-blue-600 hover:text-blue-800" aria-label="חודש הבא">חודש הבא &gt;</button>
                </div>
                <div class="text-right mb-4">
                    <p>סה"כ שעות בחודש: <span id="total-hours"></span></p>
                </div>
                <div class="grid grid-cols-7 gap-2 text-center" role="grid" aria-label="לוח שנה חודשי">
                    <div class="font-bold" role="columnheader">ראשון</div>
                    <div class="font-bold" role="columnheader">שני</div>
                    <div class="font-bold" role="columnheader">שלישי</div>
                    <div class="font-bold" role="columnheader">רביעי</div>
                    <div class="font-bold" role="columnheader">חמישי</div>
                    <div class="font-bold" role="columnheader">שישי</div>
                    <div class="font-bold" role="columnheader">שבת</div>
            `;

// Add empty cells for days before the 1st of the month
            for (let i = 0; i < startOfMonth.weekday % 7; i++) {
                html += '<div class="bg-gray-100 p-2 h-24" role="gridcell"></div>';
            }

            // Add cells for each day of the month
            for (let day = 1; day <= totalDays; day++) {
                const date = startOfMonth.set({ day });
                const dayLogs = workLogs.filter(log => DateTime.fromISO(log.date).hasSame(date, 'day'));
                const totalHours = calculateTotalHours(dayLogs);

                html += `
                    <div class="bg-white p-2 h-24 border cursor-pointer" role="gridcell" tabindex="0" onclick="displayDayView('${date.toISO()}')" aria-label="${date.toFormat('d בMMMM')}" data-date="${date.toISODate()}">
                        <div class="font-bold">${day}</div>
                        <div class="text-sm">${totalHours.toFixed(1)} שעות</div>
                    </div>
                `;
            }

            html += '</div>';
            reportContent.innerHTML = html;

            // Update total hours for the month
            const totalMonthHours = calculateTotalHours(workLogs.filter(log => 
                DateTime.fromISO(log.date).hasSame(currentDate, 'month')
            ));
            document.getElementById('total-hours').textContent = totalMonthHours.toFixed(1);
        }

        function displayDayView(dateString) {
            const date = DateTime.fromISO(dateString);
            currentDate = date;
            document.getElementById('view-selector').value = 'day';

            const reportContent = document.getElementById('report-content');
            const dayLogs = workLogs.filter(log => DateTime.fromISO(log.date).hasSame(date, 'day'))
                .sort((a, b) => a['start-time'].localeCompare(b['start-time']));

            let html = `
                <div class="flex justify-between items-center mb-4">
                    <button onclick="changeDay(-1)" class="text-blue-600 hover:text-blue-800" aria-label="יום קודם">&lt; יום קודם</button>
                    <h3 class="text-lg font-semibold">${date.toFormat('dd/MM/yyyy')}</h3>
                    <button onclick="changeDay(1)" class="text-blue-600 hover:text-blue-800" aria-label="יום הבא">יום הבא &gt;</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <h4 class="text-lg font-semibold">דיווחי היום</h4>
                        <div class="relative h-[600px] border border-gray-300 rounded">
                            ${generateTimelineHtml(dayLogs)}
                        </div>
                    </div>
                    <div>
                        <h4 class="text-lg font-semibold mb-4">הוסף דיווח חדש</h4>
                        <form id="day-work-log-form" novalidate>
                            <input type="hidden" id="day-date" name="date" value="${date.toFormat('yyyy-MM-dd')}">
                            <div class="space-y-4">
                                <div>
                                    <label for="day-type" class="block mb-2 text-sm font-medium text-gray-900">סוג דיווח:</label>
                                    <select id="day-type" name="type" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                                        <option value="">בחר סוג דיווח</option>
                                        <option value="work">עבודה רגילה</option>
                                        <option value="sick">מחלה</option>
                                        <option value="vacation">חופשה</option>
                                        <option value="reserve">מילואים</option>
                                        <option value="bereavement">אבל</option>
                                        <option value="study">ימי השתלמות</option>
                                    </select>
                                    <p id="day-type-error" class="mt-2 text-sm text-red-600 hidden"></p>
                                </div>
                                <div>
                                    <label for="day-location" class="block mb-2 text-sm font-medium text-gray-900">מיקום עבודה:</label>
                                    <input type="text" id="day-location" name="location" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required minlength="2" maxlength="50">
                                    <p id="day-location-error" class="mt-2 text-sm text-red-600 hidden"></p>
                                </div>
                                <div>
                                    <label for="day-client" class="block mb-2 text-sm font-medium text-gray-900">לקוח לחיוב:</label>
                                    <input type="text" id="day-client" name="client" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required minlength="2" maxlength="50">
                                    <p id="day-client-error" class="mt-2 text-sm text-red-600 hidden"></p>
                                </div>
                                <div>
                                    <label for="day-start-time" class="block mb-2 text-sm font-medium text-gray-900">שעת התחלה:</label>
                                    <input type="text" id="day-start-time" name="start-time" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                                    <p id="day-start-time-error" class="mt-2 text-sm text-red-600 hidden"></p>
                                </div>
                                <div>
                                    <label for="day-end-time" class="block mb-2 text-sm font-medium text-gray-900">שעת סיום:</label>
                                    <input type="text" id="day-end-time" name="end-time" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                                    <p id="day-end-time-error" class="mt-2 text-sm text-red-600 hidden"></p>
                                </div>
                                <button type="submit" class="w-full text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">הוסף דיווח</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            reportContent.innerHTML = html;

            // Initialize Flatpickr for the new form
            flatpickr("#day-start-time, #day-end-time", {
                enableTime: true,
                noCalendar: true,
                dateFormat: "H:i",
                time_24hr: true,
                minuteIncrement: 15,
            });

            // Add event listener for the new form
            document.getElementById('day-work-log-form').addEventListener('submit', handleDayFormSubmit);
        }

        function generateTimelineHtml(logs) {
            const timeSlots = new Array(24).fill().map((_, i) => {
                const time = i.toString().padStart(2, '0') + ':00';
                return `<div class="absolute w-full border-t border-gray-200 text-xs text-gray-500" style="top: ${i * (100/24)}%">${time}</div>`;
            });

            const logElements = logs.map(log => {
                const startTime = DateTime.fromFormat(log['start-time'], 'HH:mm');
                const endTime = DateTime.fromFormat(log['end-time'], 'HH:mm');
                const top = (startTime.hour + startTime.minute / 60) * (100/24);
                const height = (endTime.diff(startTime, 'minutes').minutes / 60) * (100/24);
                const color = getColorForLogType(log.type);

                return `
                    <div class="absolute right-0 w-full p-1 text-xs text-white rounded-sm overflow-hidden" 
                         style="top: ${top}%; height: ${height}%; background-color: ${color};">
                        <strong>${getHebrewType(log.type)}</strong><br>
                        ${log['start-time']} - ${log['end-time']}<br>
                        ${log.client} (${log.location})
                        <div class="mt-1">
                            <button onclick="editLog('${log.id}')" class="text-white underline mr-2">ערוך</button>
                            <button onclick="deleteLog('${log.id}')" class="text-white underline">מחק</button>
                        </div>
                    </div>
                `;
            });

            return timeSlots.join('') + logElements.join('');
        }

        function getColorForLogType(type) {
            const colors = {
                'work': '#4299e1',
                'sick': '#f56565',
                'vacation': '#48bb78',
                'reserve': '#ed8936',
                'bereavement': '#9f7aea',
                'study': '#ecc94b'
            };
            return colors[type] || '#a0aec0';
        }

        function handleDayFormSubmit(e) {
            e.preventDefault();
            if (!validateForm('day-work-log-form')) return;

            const formData = new FormData(e.target);
            const newLog = Object.fromEntries(formData.entries());
            newLog.id = Date.now().toString();

            workLogs.push(newLog);
            saveWorkLogs();
            displayDayView(currentDate.toISO());

            // Show success message
            const successMessage = document.createElement('div');
            successMessage.textContent = 'הדיווח נשמר בהצלחה';
            successMessage.className = 'bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mt-4';
            successMessage.setAttribute('role', 'alert');
            e.target.appendChild(successMessage);
            setTimeout(() => successMessage.remove(), 3000);
        }

        function changeMonth(delta) {
            currentDate = currentDate.plus({ months: delta });
            displayMonthCalendar();
        }

        function changeDay(delta) {
            currentDate = currentDate.plus({ days: delta });
            displayDayView(currentDate.toISO());
        }

        function calculateTotalHours(logs) {
            return logs.reduce((total, log) => {
                if (log.type === 'work') {
                    const startTime = DateTime.fromFormat(log['start-time'], 'HH:mm');
                    const endTime = DateTime.fromFormat(log['end-time'], 'HH:mm');
                    const duration = endTime.diff(startTime, 'hours');
                    return total + duration.hours;
                }
                return total;
            }, 0);
        }

        function getHebrewType(type) {
            const types = {
                'work': 'עבודה רגילה',
                'sick': 'מחלה',
                'vacation': 'חופשה',
                'reserve': 'מילואים',
                'bereavement': 'אבל',
                'study': 'ימי השתלמות'
            };
            return types[type] || type;
        }

        function editLog(id) {
            const log = workLogs.find(log => log.id === id);
            if (log) {
                document.getElementById('edit-id').value = log.id;
                document.getElementById('edit-date').value = log.date;
                document.getElementById('edit-type').value = log.type;
                document.getElementById('edit-location').value = log.location;
                document.getElementById('edit-client').value = log.client;
                document.getElementById('edit-start-time').value = log['start-time'];
                document.getElementById('edit-end-time').value = log['end-time'];
                
                const modal = new Modal(document.getElementById('edit-modal'));
                modal.show();
            }
        }

        document.getElementById('edit-form').addEventListener('submit', function(e) {
            e.preventDefault();
            if (!validateForm('edit-form')) return;

            const formData = new FormData(e.target);
            const updatedLog = Object.fromEntries(formData.entries());
            const id = document.getElementById('edit-id').value;
            
            const index = workLogs.findIndex(log => log.id === id);
            if (index !== -1) {
                workLogs[index] = { ...workLogs[index], ...updatedLog };
                saveWorkLogs();
                updateReport();
                const modal = Modal.getInstance(document.getElementById('edit-modal'));
                modal.hide();

                // Show success message
                const successMessage = document.createElement('div');
                successMessage.textContent = 'הדיווח עודכן בהצלחה';
                successMessage.className = 'bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mt-4';
                successMessage.setAttribute('role', 'alert');
                document.getElementById('report-container').insertAdjacentElement('afterbegin', successMessage);
                setTimeout(() => successMessage.remove(), 3000);
            }
        });

        function deleteLog(id) {
            const confirmDelete = confirm('האם אתה בטוח שברצונך למחוק רשומה זו?');
            if (confirmDelete) {
                workLogs = workLogs.filter(log => log.id !== id);
                saveWorkLogs();
                updateReport();

                // Show success message
                const successMessage = document.createElement('div');
                successMessage.textContent = 'הדיווח נמחק בהצלחה';
                successMessage.className = 'bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mt-4';
                successMessage.setAttribute('role', 'alert');
                document.getElementById('report-container').insertAdjacentElement('afterbegin', successMessage);
                setTimeout(() => successMessage.remove(), 3000);
            }
        }
        // Error handling for localStorage
        function safelyParseJSON(json) {
            try {
                return JSON.parse(json);
            } catch (e) {
                console.error('Error parsing JSON from localStorage:', e);
                return null;
            }
        }

        // Performance optimization for large datasets
        function lazyLoadWorkLogs() {
            const storedLogs = localStorage.getItem('workLogs');
            if (storedLogs) {
                const parsedLogs = safelyParseJSON(storedLogs);
                if (parsedLogs && Array.isArray(parsedLogs)) {
                    workLogs = parsedLogs;
                } else {
                    console.error('Invalid data in localStorage');
                    workLogs = [];
                }
            }
        }

        // Call this function instead of directly accessing localStorage on page load
        lazyLoadWorkLogs();

        // Function to handle network errors or other issues when saving data
        function handleSaveError(error) {
            console.error('Error saving work logs:', error);
            alert('אירעה שגיאה בשמירת הנתונים. אנא נסה שנית מאוחר יותר.');
        }

        // Update the saveWorkLogs function to handle errors
        function saveWorkLogs() {
            try {
                localStorage.setItem('workLogs', JSON.stringify(workLogs));
            } catch (error) {
                handleSaveError(error);
            }
        }

        // Add event listeners for form field auto-complete
        const locationInput = document.getElementById('day-location');
        const clientInput = document.getElementById('day-client');
        const locationDatalist = document.createElement('datalist');
        const clientDatalist = document.createElement('datalist');
        locationDatalist.id = 'location-options';
        clientDatalist.id = 'client-options';
        locationInput.setAttribute('list', 'location-options');
        clientInput.setAttribute('list', 'client-options');
        document.body.appendChild(locationDatalist);
        document.body.appendChild(clientDatalist);

        function updateDatalist(input, datalist) {
            const uniqueValues = [...new Set(workLogs.map(log => log[input.name]))];
            datalist.innerHTML = uniqueValues.map(value => `<option value="${value}">`).join('');
        }

        locationInput.addEventListener('focus', () => updateDatalist(locationInput, locationDatalist));
        clientInput.addEventListener('focus', () => updateDatalist(clientInput, clientDatalist));

        // Add tooltips for time inputs
        const timeInputs = document.querySelectorAll('input[type="time"]');
        timeInputs.forEach(input => {
            input.title = 'הזן זמן בפורמט 24 שעות (לדוגמה: 13:30)';
        });

        // Ensure the design is responsive
        function adjustLayoutForScreenSize() {
            const container = document.querySelector('.container');
            if (window.innerWidth < 640) {
                container.classList.remove('mx-auto');
                container.classList.add('mx-2');
            } else {
                container.classList.add('mx-auto');
                container.classList.remove('mx-2');
            }
        }

        window.addEventListener('resize', adjustLayoutForScreenSize);
        adjustLayoutForScreenSize(); // Call on initial load

        // Initialize the report
        updateReport();

        // Add keyboard navigation for calendar
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('view-selector').value === 'month') {
                const focusedDay = document.activeElement;
                if (focusedDay.getAttribute('role') === 'gridcell') {
                    const currentDate = DateTime.fromISO(focusedDay.getAttribute('data-date'));
                    let newDate;

                    switch (e.key) {
                        case 'ArrowRight':
                            newDate = currentDate.minus({ days: 1 });
                            break;
                        case 'ArrowLeft':
                            newDate = currentDate.plus({ days: 1 });
                            break;
                        case 'ArrowUp':
                            newDate = currentDate.minus({ weeks: 1 });
                            break;
                        case 'ArrowDown':
                            newDate = currentDate.plus({ weeks: 1 });
                            break;
                        default:
                            return;
                    }

                    e.preventDefault();
                    const newFocusedDay = document.querySelector(`[data-date="${newDate.toISODate()}"]`);
                    if (newFocusedDay) {
                        newFocusedDay.focus();
                    }
                }
            }
        });

        // Function to handle overlapping reports in the timeline
        function handleOverlappingReports(logs) {
            logs.sort((a, b) => a['start-time'].localeCompare(b['start-time']));
            const overlaps = new Array(logs.length).fill(0);

            for (let i = 0; i < logs.length; i++) {
                for (let j = 0; j < i; j++) {
                    if (logs[i]['start-time'] < logs[j]['end-time']) {
                        overlaps[i] = Math.max(overlaps[i], overlaps[j] + 1);
                    }
                }
            }

            return logs.map((log, index) => ({ ...log, overlap: overlaps[index] }));
        }

        // Update the generateTimelineHtml function to handle overlapping reports
        function generateTimelineHtml(logs) {
            const timeSlots = new Array(24).fill().map((_, i) => {
                const time = i.toString().padStart(2, '0') + ':00';
                return `<div class="absolute w-full border-t border-gray-200 text-xs text-gray-500" style="top: ${i * (100/24)}%">${time}</div>`;
            });

            const processedLogs = handleOverlappingReports(logs);
            const maxOverlap = Math.max(...processedLogs.map(log => log.overlap));

            const logElements = processedLogs.map(log => {
                const startTime = DateTime.fromFormat(log['start-time'], 'HH:mm');
                const endTime = DateTime.fromFormat(log['end-time'], 'HH:mm');
                const top = (startTime.hour + startTime.minute / 60) * (100/24);
                const height = (endTime.diff(startTime, 'minutes').minutes / 60) * (100/24);
                const color = getColorForLogType(log.type);
                const width = 100 / (maxOverlap + 1);
                const left = (log.overlap * width);

                return `
                    <div class="absolute p-1 text-xs text-white rounded-sm overflow-hidden" 
                         style="top: ${top}%; height: ${height}%; background-color: ${color}; width: ${width}%; left: ${left}%;">
                        <strong>${getHebrewType(log.type)}</strong><br>
                        ${log['start-time']} - ${log['end-time']}<br>
                        ${log.client} (${log.location})
                        <div class="mt-1">
                            <button onclick="editLog('${log.id}')" class="text-white underline mr-2">ערוך</button>
                            <button onclick="deleteLog('${log.id}')" class="text-white underline">מחק</button>
                        </div>
                    </div>
                `;
            });

            return timeSlots.join('') + logElements.join('');
        }

        // Function to export work logs as CSV
        function exportToCSV() {
            const headers = ['תאריך', 'סוג דיווח', 'מיקום עבודה', 'לקוח לחיוב', 'שעת התחלה', 'שעת סיום'];
            const csvContent = [
                headers.join(','),
                ...workLogs.map(log => [
                    log.date,
                    getHebrewType(log.type),
                    log.location,
                    log.client,
                    log['start-time'],
                    log['end-time']
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "work_logs.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Add export button to the UI
        const exportButton = document.createElement('button');
        exportButton.textContent = 'ייצא לקובץ CSV';
        exportButton.className = 'mt-4 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded';
        exportButton.onclick = exportToCSV;
        document.querySelector('.container').appendChild(exportButton);

    </script>
</body>
</html>
